name: Manual Test Trigger Execution

on:
  workflow_dispatch:
    inputs:
      device:
        description: 'Device type to test'
        required: true
        default: 'desktop'
        type: choice
        options:
          - desktop
          - mobile
          - ipad
      tags:
        description: 'Test tags to run (e.g., homepage, smoke)'
        required: true
        default: ''
        type: string
      headless:
        description: 'Run in headless mode'
        required: false
        default: true
        type: boolean
      parallel:
        description: 'Run tests in parallel'
        required: false
        default: true
        type: boolean
      workers:
        description: 'Number of parallel workers (if parallel is true)'
        required: false
        default: '3'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
      stagehand_model:
        description: 'Stagehand model to use'
        required: false
        default: 'gpt-5-nano'
        type: string

jobs:
  manual-tests:
    name: Run Manual Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright Chromium
        run: |
          python -m playwright install chromium
          python -m playwright install-deps chromium

      - name: Run tests
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          CMD="pytest --device=${{ inputs.device }}"
          [ "${{ inputs.headless }}" == "true" ] && CMD="$CMD --headless"
          [ -n "${{ inputs.tags }}" ] && CMD="$CMD -m \"${{ inputs.tags }}\""
          [ "${{ inputs.parallel }}" == "true" ] && CMD="$CMD -n ${{ inputs.workers }} --dist=loadscope"
          CMD="$CMD --stagehand-model=${{ inputs.stagehand_model }} --reruns=2 --reruns-delay=1 -v"
          echo "Running: $CMD"
          eval $CMD

      - name: Summary
        if: always()
        run: |
          echo "## Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Device**: ${{ inputs.device }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags**: ${{ inputs.tags || 'All tests' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Headless**: ${{ inputs.headless }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Parallel**: ${{ inputs.parallel }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.parallel }}" == "true" ]; then
            echo "- **Workers**: ${{ inputs.workers }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Model**: ${{ inputs.stagehand_model }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

